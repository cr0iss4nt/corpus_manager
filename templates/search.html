{% extends "base.html" %}

{% block title %}Поиск: {{query}}{% endblock %}

{% block content %}
<div class="container mb-3">
    <h2>Поиск по запросу: {{query}}</h2>
    <!--<p>Результатов поиска по словоформе: {{word_number}}</p>
    <p>Результатов поиска по лемме: {{lemma_number}}</p>
    <p>Всего: {{result_number}}</p>-->

    <div class="container">
        <div class="row">
            <div class="col-4">
                {% with word_number=word_number, lemma_number=lemma_number, result_number=result_number%}
                    {% include 'results.html'%}
                {% endwith%}
            </div>
            <div class="col-4">
                {% with frequency=freq1%}
                    {% if freq1 %}
                    {% include 'frequency_analysis.html'%}
                    {% endif %}
                {% endwith%}
            </div>
            <div class="col-4">
                {% with frequency=freq2%}
                    {% if freq2 %}
                    {% include 'frequency_analysis.html'%}
                    {% endif %}
                {% endwith%}
            </div>
        </div>
    </div>




    <button onclick="exportDictionary()" class="btn btn-sm btn-primary">
        <i class="bi bi-upload"></i> Экспорт
    </button>
    <form id="exportForm" action="/export" method="POST" style="display: none;">
    <input type="hidden" name="query" value='{{query}}'>
</form>
</div>

<script>
    function exportDictionary() {
        // Create form data
        const formData = new FormData();
        formData.append('query', '{{query}}');

        // send request to server
        fetch('/export', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Export failed');
            }

            // get filename or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'corpus.txt';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename=(.+)/);
                if (match) {
                    filename = match[1];
                }
            }

            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            // create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // cleanup
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при экспорте словаря');
        });
    }
</script>

{% with words=words%}
    {% include 'words.html'%}
{% endwith%}


{% endblock %}