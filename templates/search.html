{% extends "base.html" %}

{% block title %}Поиск: {{query}}{% endblock %}

{% block content %}
<div class="container mb-3">
    <h2>Поиск по запросу: {{query}}</h2>

    {% if result_number == 0 %}
        <p>Поиск по данному запросу не дал результатов.</p>
    {% else %}


    <div class="container">
        <div class="row">
            <div class="col-4">
                {% with word_number=word_number, lemma_number=lemma_number, result_number=result_number %}
                    {% include 'results.html'%}
                {% endwith%}
            </div>
            <div class="col-4">
                {% with frequency=freq1%}
                    {% if freq1 %}
                    {% include 'frequency_analysis.html'%}
                    {% endif %}
                {% endwith%}
            </div>
            <div class="col-4">
                {% with frequency=freq2%}
                    {% if freq2 %}
                    {% include 'frequency_analysis.html'%}
                    {% endif %}
                {% endwith%}
            </div>
        </div>
    </div>




    <button onclick="exportCorpus()" class="btn btn-sm btn-primary">
        <i class="bi bi-upload"></i> Экспорт
    </button>
    <form id="exportForm" action="/export" method="POST" style="display: none;">
        <input type="hidden" name="query" value='{{query}}'>
    </form>

    {% if result_number > 500 %}
    <p>Показаны лишь первые 500 результатов для сохранения производительности.</p>
    {% endif %}


    <script>
    function exportCorpus() {
        // Create form data
        const formData = new FormData();
        formData.append('query', '{{query}}');

        // send request to server
        fetch('/export', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Export failed');
            }

            // get filename or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'corpus.txt';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename=(.+)/);
                if (match) {
                    filename = match[1];
                }
            }

            return response.blob().then(blob => ({ blob, filename }));
        })
        .then(({ blob, filename }) => {
            // create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // cleanup
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при экспорте словаря');
        });
    }
    </script>


    <div class="row">
        <div class="col-6">
            {% with words=words%}
                {% include 'words.html'%}
            {% endwith%}
        </div>
        <div class="col-6">
            {% with words=word_features%}
                {% include 'word_features.html'%}
            {% endwith%}
        </div>
    </div>


    {% endif %}

</div>
{% endblock %}